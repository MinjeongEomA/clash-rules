name: Update Clash Rules

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC 00:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-rules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm init -y
          npm install axios
      
      - name: Create scripts directory
        run: mkdir -p scripts
      
      - name: Create conversion script
        run: |
          cat > scripts/convert-rules.js << 'SCRIPT_EOL'
const fs = require('fs');
const path = require('path');
const axios = require('axios');

// è½¬æ¢Surgeè§„åˆ™ä¸ºClashè§„åˆ™
function convertSurgeRuleToClash(surgeRule) {
  // å¿½ç•¥æ³¨é‡Šå’Œç©ºè¡Œ
  if (surgeRule.trim().startsWith('#') || surgeRule.trim() === '') {
    return surgeRule;
  }

  // å¤„ç†åŸºæœ¬è§„åˆ™ç±»åž‹
  if (surgeRule.startsWith('DOMAIN,') ||
      surgeRule.startsWith('DOMAIN-SUFFIX,') ||
      surgeRule.startsWith('DOMAIN-KEYWORD,') ||
      surgeRule.startsWith('IP-CIDR,') ||
      surgeRule.startsWith('IP-CIDR6,') ||
      surgeRule.startsWith('GEOIP,')) {
    return surgeRule;
  }

  // å…¶ä»–ä¸æ”¯æŒçš„è§„åˆ™ç±»åž‹
  return null;
}

// è½¬æ¢Surgeè§„åˆ™é›†ä¸ºClashè§„åˆ™é›†
function convertSurgeRulesToClash(surgeRules) {
  const lines = surgeRules.split('\n');
  let header = [];
  let rules = [];
  
  // æå–å¤´éƒ¨æ³¨é‡Š
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].startsWith('#')) {
      header.push(lines[i]);
    } else if (lines[i].trim() !== '') {
      break;
    }
  }
  
  // è½¬æ¢è§„åˆ™
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    if (line === '' || line.startsWith('#')) {
      continue;
    }
    
    const clashRule = convertSurgeRuleToClash(line);
    if (clashRule !== null) {
      rules.push(clashRule);
    }
  }
  
  // æž„å»ºClashè§„åˆ™é›†
  const clashRules = [
    ...header,
    '',
    'payload:'
  ];
  
  rules.forEach(rule => {
    clashRules.push(`  - ${rule}`);
  });
  
  return clashRules.join('\n');
}

// è§„åˆ™é›†åˆ—è¡¨
const ruleSets = [
  { name: 'AI', path: 'Rules/AI/AI.list' },
  { name: 'OpenAI', path: 'Rules/OpenAI/OpenAI.list' },
  { name: 'GitHub', path: 'Rules/GitHub/GitHub.list' },
  { name: 'Google', path: 'Rules/Google/Google.list' },
  { name: 'Microsoft', path: 'Rules/Microsoft/Microsoft.list' },
  { name: 'Telegram', path: 'Rules/Telegram/Telegram.list' },
  { name: 'Netflix', path: 'Rules/Netflix/Netflix.list' },
  { name: 'YouTube', path: 'Rules/YouTube/YouTube.list' },
  { name: 'Global', path: 'Rules/Global/Global.list' },
  { name: 'Mainland', path: 'Rules/Mainland/Mainland.list' }
];

// GitHubä»“åº“åŸºç¡€URL
const baseUrl = 'https://raw.githubusercontent.com/mist-whisper/Surge/refs/heads/master/'\;

// ä¸»å‡½æ•°
async function main() {
  console.log('Starting conversion...');
  
  const results = [];
  for (const ruleSet of ruleSets) {
    try {
      console.log(`Processing ${ruleSet.name}...`);
      
      // ä¸‹è½½Surgeè§„åˆ™é›†
      const url = baseUrl + ruleSet.path;
      const response = await axios.get(url);
      const surgeRules = response.data;
      
      // è½¬æ¢ä¸ºClashè§„åˆ™é›†
      const clashRules = convertSurgeRulesToClash(surgeRules);
      
      // æ·»åŠ è§„åˆ™é›†å…ƒæ•°æ®
      const now = new Date();
      const formattedDate = now.toISOString().split('T')[0];
      const metadata = [
        `# NAME: ${ruleSet.name}`,
        `# AUTHOR: MinjeongEom (converted from mist-whisper/Surge)`,
        `# UPDATED: ${formattedDate}`,
        `# DESCRIPTION: Clashè§„åˆ™é›†ï¼Œç”±Surgeè§„åˆ™é›†è‡ªåŠ¨è½¬æ¢`,
        `# SOURCE: https://github.com/mist-whisper/Surge/blob/master/${ruleSet.path}`,
        `# CONVERTER: https://github.com/MinjeongEomA/clash-rules`,
        ``
      ].join('\n');
      
      const finalContent = clashRules.startsWith('#') 
        ? clashRules.replace(/^(#[^\n]*\n)+/, metadata) 
        : metadata + clashRules;
      
      // åˆ›å»ºè§„åˆ™é›†ç›®å½•
      const dirName = path.dirname(ruleSet.path).replace('Rules/', '');
      const ruleDir = path.join('.', dirName);
      
      if (!fs.existsSync(ruleDir)) {
        fs.mkdirSync(ruleDir, { recursive: true });
      }
      
      // ä¿å­˜Clashè§„åˆ™é›†
      const outputPath = path.join(ruleDir, `${ruleSet.name}.yaml`);
      fs.writeFileSync(outputPath, finalContent);
      
      console.log(`Converted ${ruleSet.name} successfully.`);
      results.push({
        name: ruleSet.name,
        directory: dirName,
        path: outputPath,
        content: finalContent
      });
    } catch (err) {
      console.error(`Error processing ${ruleSet.name}:`, err.message);
    }
  }
  
  console.log(`Converted ${results.length} rule sets.`);
  
  // æ›´æ–°README.md
  const readme = `# Clash Rules

è¿™ä¸ªä»“åº“åŒ…å«äº†è‡ªåŠ¨ä»Ž[mist-whisper/Surge](https://github.com/mist-whisper/Surge)è½¬æ¢çš„Clashè§„åˆ™é›†ã€‚

æœ€åŽæ›´æ–°æ—¶é—´: ${new Date().toISOString().split('T')[0]}

## è§„åˆ™é›†åˆ—è¡¨

${ruleSets.map(r => `- [${r.name}](${r.path.replace('Rules/', '').replace('.list', '.yaml')})`).join('\n')}

## ä½¿ç”¨æ–¹æ³•

åœ¨Clashé…ç½®ä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¼•ç”¨è¿™äº›è§„åˆ™é›†ï¼š

\`\`\`yaml
rule-providers:
  ai:
    type: http
    behavior: classical
    url: https://raw.githubusercontent.com/MinjeongEomA/clash-rules/main/AI/AI.yaml
    path: ./ruleset/ai.yaml
    interval: 86400
\`\`\`

ç„¶åŽåœ¨è§„åˆ™ä¸­å¼•ç”¨ï¼š

\`\`\`yaml
rules:
  - RULE-SET,ai,PROXY
\`\`\`

## åœ¨mihomo partyä¸­ä½¿ç”¨

åœ¨mihomo partyé…ç½®ä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¼•ç”¨è¿™äº›è§„åˆ™é›†ï¼š

\`\`\`javascript
// æ·»åŠ AIè§„åˆ™é›†
providers["ai"] = {
  "behavior": "classical",
  "url": \`https://raw.githubusercontent.com/MinjeongEomA/clash-rules/main/AI/AI.yaml\`,
  "path": \`./ruleset/ai.yaml\`,
  "interval": 86400
};
\`\`\`

ç„¶åŽåœ¨è§„åˆ™ä¸­å¼•ç”¨ï¼š

\`\`\`javascript
"RULE-SET,ai,ðŸ¤–æ™ºèƒ½åŠ©ç†",
\`\`\`

## è‡ªåŠ¨æ›´æ–°

è¿™ä¸ªä»“åº“æ¯å¤©è‡ªåŠ¨ä»ŽSurgeè§„åˆ™é›†æ›´æ–°ï¼Œç¡®ä¿è§„åˆ™å§‹ç»ˆæ˜¯æœ€æ–°çš„ã€‚
`;
  
  fs.writeFileSync('README.md', readme);
  console.log('Updated README.md');
}

// æ‰§è¡Œä¸»å‡½æ•°
main().catch(err => {
  console.error('Conversion failed:', err);
  process.exit(1);
});
SCRIPT_EOL
      
      - name: Run conversion script
        run: node scripts/convert-rules.js
      
      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Update rules $(date +'%Y-%m-%d')" || echo "No changes to commit"
          git push
